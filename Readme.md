
Приложение Sweater - Аналог твиттера
***

[канал let's code](https://www.youtube.com/channel/UC1g3kT0ZcSXt4_ZyJOshKJQ)
***

#### Этапы

* подготовка
    * идем на spring.io
    * в гайдах ищем MVC
    * создаём проект maven
    
          
* урок 1 (Hello, World)
    * pom.xml
        * указываем используемую версию java
        * секцию **parent** для spring boot
        * зависимости:
            * thymeleaf (шаблонизатор)
            * starter-web
            * dev-tools (для удобного перезапуска приложения)
            * тестирование
        * а также плагин для сборки
    * добавляем GreetingController
    * а также класс запуска приложения ServingWebContentApplication
    * и страницу greeting.html, которая просто отображает имя, переданное через get-параметр name


* урок 1 (Hello, World). часть 2. замена thymeleaf на mustache (шаблонизатор попроще)
    * изменяем dependency
    * greeting.html на greeting.mustache
        * убираем пространство имен thymeleaf-а
        * изменяем шаблон вывода сообщения
    * в контроллере вместо модели теперь используется Map<String, Object>
    * а также добавлен обработчик для главной страницы
    
    
* урок 2. подключение БД
    * устанавливаем postgres (опционально, вместо MySQL из гайда спринга)
        * [Postgre SQL для Windows](https://www.postgresql.org/download/windows/)
        * если при установке не был запрошен пароль, то по [инструкции](https://overcoder.net/q/9607/%D1%8F-%D0%B7%D0%B0%D0%B1%D1%8B%D0%BB-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8C-%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%8B%D0%B9-%D0%B2%D0%B2%D0%B5%D0%BB-%D0%BF%D1%80%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B5-postgres) сбрасываем пароль и устанавливаем новый
        * проверяем подключение к БД например через вкладку Database в Intellij IDEA
        * также доступ к БД можно осуществить через консоль pgAdmin
        * основной синтаксис можно посмотреть например [здесь](https://metanit.com/sql/postgresql/1.1.php)
    * добавляем lombok (опционально)
    * ищем гайд подключения БД на сайте спринга (MySQL)
        * добавляем зависимости JPA и postgresql
        * добавляем properties и прописываем настройки подключения БД
        * добавляем package domain для хранения сущностей БД
            * добавляем в него entity "сообщений"
                * для класса entity нужен конструктор по умолчанию
        * добавляем package repo для доступа к сущностям БД с помощью JPA
            * создаем репозиторий MessageRepository на основе CrudRepository
        * выводим на главную страницу список сообщений
            * добавляем форму на страницу ([manual](http://mustache.github.io/mustache.5.html) по mustache)
            * переписываем меппинг main в контроллере, используя MessageRepository
        * даем пользователям возможность добавлять сообщения в БД
            * рисуем форму ввода для добавления сообщений в БД
            * добавляем обработчик в контроллер (при сохранении в БД используем [redirect](https://www.baeldung.com/spring-redirect-and-forward))
        * фильтры сообщений
            * добавляем форму отбора по тегу
            * навешиваем post обработчик
            * добавляем в MessageRepository поиск сообщений по тегу используя [DSL Spring Data](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation)


* урок 3. авторизация, пользователи
    * всё стандартно: ищем спринговский [гайд](https://spring.io/guides/gs/securing-web/) по security web
    * главной страницей теперь будет greeting
        * меняем меппинги для greeting -> **'/'** и для main -> **'/main'**
        * action-ы для форм
        * и redirect: в контроллере
        * убираем передаваемые параметры (обезличиваем)
        * на странице приветствия располагаем ссылку на главную страницу
    * добавляем зависимость spring-boot-starter-security
    * определяем package config, в котором будут располагаться конфигурационные классы спринга
        * добавляем конфиг для простого меппинга страниц без использования контроллера (реализуя интерфейс WebMvcConfigurer)
        * добавляем конфиг для настройки доступа (реализуем интерфейс WebSecurityConfigurerAdapter)
            * помечается аннотацией EnableWebSecurity для включения интеграции Spring Security и Spring MVC
            * переопределяем configure для детальной настройки доступа
            * и (временно) userDetailsService для проверки входа пользователя (хардкодом добавляем пользователя в список)
    * добавляем страницу логина
    * на главную страницу добавляем кнопку logout
    * из-за того, что используем Mustache, у нас не будет автоматического пробрасывания [CSRF](https://ru.wikipedia.org/wiki/Межсайтовая_подделка_запроса) (как было бы в случае с thymeleaf)
        * csrf 
        * expose-request-attributes = true
        * во все страницы во все формы с "POST" добавляем невидимое поле пробрасывания csrf токена
    * удаляем захардкоженного пользователя и добавляем возможность работать с пользователями в БД
        * сущность User
            * служебная сущность Role (enum)
            * Set ролей для пользователя со связями и ленивой инициализацией
        * удаляем userDetailsService в конфиг классе и вместо него переопределяем configure(AuthenticationManagerBuilder auth)
            * устанавливаем jdbc-аутентификацию
            * datasource для хождения в БД
            * получение полей пользователя
            * получение списка ролей пользователя
        * добавляем страницу регистрации пользователей и ссылку на нее со страницы логина
        * создаем новый контроллер для работы с обработчиками событий пользователей RegistrationController
            * обработчик перехода на страницу регистрации
            * обработчик добавления нового пользователя с проверкой существования и вывода сообщения на странице регистрации, если проверку не прошёл
                * также в WebSecurityConfig добавляем права для всех пользователей на страницу registration
        * все контроллеры выносим в отдельный package
        

